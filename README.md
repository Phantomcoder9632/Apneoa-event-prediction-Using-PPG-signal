# Sleep Apnea Event Prediction using PPG Signals

A 1D Convolutional Neural Network (CNN) built in PyTorch to predict upcoming sleep apnea events. The model analyzes 30-second windows of a patient's Photoplethysmography (PPG) signal to forecast an apnea event 5 seconds in the future.

This repository contains the complete pipeline for data preprocessing (filtering, resampling, and windowing), model training, 5-fold cross-validation, and performance visualization.

## üìä Results Dashboard

The evaluation scripts generate a comprehensive set of plots to analyze model performance across 5 cross-validation folds and a final hold-out test set.

| Training Curves | CV Performance |
| :---: | :---: |
| ![Training Curves](results_1_training_curves.jpg) | ![CV Performance](results_2_cv_performance.jpg) |
| **Confusion Matrices** | **Performance Variability** |
| ![Confusion Matrices](results_3_confusion_matrices.jpg) | ![Variability Analysis](results_5_variability_analysis.jpg) |
| **ROC Curves** | **Performance Comparison (Radar Plot)** |
| ![ROC Curves](results_6_roc_curves.jpg) | ![Radar Plot](results_4_spider_plot.jpg) |

---

## üî¨ How It Works: Methodology

The model's task is to predict an upcoming apnea event. It works by analyzing a **30-second** window of "normal" PPG data (green section) and predicting if an apnea event (red section) will begin after a **5-second** lead time (orange section).

Below are examples of *correctly predicted* (True Positive) events from the test set, generated by `prediction_window_plot.py`.

![True Positive Examples for Patient 7](patient_7_TRUE_POSITIVES_ABS_TIME.jpg)
![True Positive Examples for Patient 17](patient_17_TRUE_POSITIVES_ABS_TIME.jpg)

---

## üìà Performance Metrics

The model was evaluated using a 5-Fold Group Cross-Validation (grouped by patient) and a final hold-out test set.

### Hold-Out Test Set Results
| Metric | Score |
| :--- | :--- |
| **AUC** | **0.7200** |
| **F1-Score** | **0.7982** |
| **Recall (Sensitivity)** | **0.8403** |
| **Precision** | **0.7601** |
| **Specificity** | **0.7335** |

### 5-Fold Cross-Validation (Average)
| Metric | Score (Mean ¬± Std) |
| :--- | :--- |
| **AUC** | 0.6840 ¬± 0.0176 |
| **F1-Score**| 0.6504 ¬± 0.0063 |
| **Recall** | 0.8771 ¬± 0.0222 |
| **Precision** | 0.5266 ¬± 0.0266 |

---

## üõ†Ô∏è Technology Stack

* **Python 3.x**
* **PyTorch**: For building and training the 1D CNN model.
* **Pandas**: For data loading and manipulation.
* **NumPy** & **SciPy**: For signal processing, filtering, and resampling (from 80Hz to 100Hz).
* **Scikit-learn**: For performance metrics (AUC, F1, etc.) and Group K-Fold splitting.
* **Matplotlib** & **Seaborn**: For generating all visualizations.

---

## üöÄ How to Run

1.  **Clone the repository:**
    ```bash
    git clone [https://github.com/Phantomcoder9632/Apneoa-event-prediction-Using-PPG-signal.git](https://github.com/Phantomcoder9632/Apneoa-event-prediction-Using-PPG-signal.git)
    cd Apneoa-event-prediction-Using-PPG-signal
    ```

2.  **Create a Python environment and install dependencies:**
    *(This assumes you have a `requirements.txt` file, or you can install them manually)*
    ```bash
    # Create a virtual environment
    python -m venv venv
    # Activate it
    source venv/bin/activate  # (On Windows, use `venv\Scripts\activate`)
    
    # Install requirements
    pip install numpy pandas matplotlib seaborn scikit-learn torch scipy tqdm
    ```

3.  **(Optional) Run the True Positive Visualizer:**
    This script loads the *trained model* (`my_final_apnea_predictor.pth`) and the *data* (`data/CNN_input_data.pickle`) to generate the signal-level prediction plots.
    ```bash
    python prediction_window_plot.py
    ```
    Plots will be saved to the `model_true_positive_plots/` directory.

4.  **(Advanced) Run the Full Training Pipeline:**
    This script re-trains the model from scratch, performs the 5-fold CV, evaluates on the test set, and saves a new `.pth` file.
    ```bash
    python run_full_evaluation.py
    ```